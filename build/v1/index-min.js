/* JBC build, 2013-06-21 1:01:22 PM */
KISSY.add("jbc/jupicker/v1/index",function(a,b,c){var d=function(a){var b=this,c={limit:40,containers:".J_jupicker",data_item:"data-item",data_template:"data-template",url:"http://ju.taobao.com/json/tg/AjaxGetJsonItems.htm",class_done:"jupicker-complete",autoload:!0,clear:!1,callback:null,idtype:"item",imglazyload:!1,template:null,trace:!1};for(var d in c)b[d]=void 0!=a[d]?a[d]:c[d];b.allItems={},b.containersDOM=[],b.itemId=[],b.itemTemplate=[],b.batchItems=[],b.successfulItemCount=0,b.currentTime=(new Date).getTime(),b.templateHtml={"default":'<div class="ju-itemlist">                            <ul class="clearfix midimg">                                {{#each list as item}}                                    <li class="{{item.state}}" data-itemid="{{item.itemId}}">                                        <a target="_blank" href="{{item.juUrl}}" class="link-box" title="{{item.longName}}">                                            <img class="item-pic" src="{{item.picUrl}}_300x300.jpg">                                            <i class="soldout-mask"></i>                                            <h3>{{item.shortName}}</h3>                                            <div class="item-prices">                                                <span class="price"><i>&yen;</i><em>{{item.activityPriceInt}}</em>.{{item.activityPriceDecimal}}</span>                                                <div class="dock">                                                    <span class="discount"><em>{{item.discount}}</em>折</span>                                                    <del class="orig-price">&yen;{{item.originalPrice}}</del>                                                </div>                                                {{#if item.state == "notbegin"}}                                                    {{#if item.remindNum != "0"}}                                                        <span class="sold-num"><em>{{item.remindNum}}</em>人想买</span>                                                    {{#else}}                                                        <span class="sold-num">即将开团</span>                                                    {{/if}}                                                {{#else}}                                                    <span class="sold-num"><em>{{item.soldCount}}</em>人已买</span>                                                {{/if}}                                            </div>                                        </a>                                    </li>                                {{/each}}                            </ul>                        </div>'},b.autoload===!0&&b.init()};return d.prototype={getItemid:function(){var c=this,d="string"==typeof c.containers?a.all(c.containers):c.containers,e=1;c.containersDOM.length=0,a.each(d,function(b){c.containersDOM.push(a.one(b))}),c.itemId.length=0;for(var f=0;f<c.containersDOM.length;f++){var g=c.containersDOM[f],h=b.attr(c.containersDOM[f],c.data_item)||"",i=h.replace(/[^\d^,]/g,"").split(","),j=b.attr(c.containersDOM[f],c.data_template),k=null;g.removeClass(c.class_done),j?(k=a.one(j)?a.one(j).html():!1,c.itemTemplate[f]=k||c.templateHtml[j]||c.templateHtml["default"]):c.template?(k=a.one(c.template)?a.one(c.template).html():!1,c.itemTemplate[f]=k||c.templateHtml[c.template]||c.template):c.itemTemplate[f]=c.templateHtml["default"],c.imglazyload&&(c.itemTemplate[f]=c.itemTemplate[f].replace(/src/gi,"data-ks-lazyload")),void 0===c.itemId[f]&&(c.itemId[f]=[]);for(var l=0;l<i.length;l++)""!=i[l]&&(c.allItems[i[l]]="null",c.itemId[f][l]=i[l])}c.batchItems.length=0;for(_item in c.allItems){var l=Math.ceil(e/c.limit)-1;c.batchItems[l]||(c.batchItems[l]=[]),c.batchItems[l].push(_item),e++}},getItemData:function(){function b(b){var c=d.idtype+"Ids",e=c+"="+(d.batchItems[b]||[]).toString();a.io({dataType:"jsonp",url:d.url,processData:!1,data:e,jsonp:"callback",success:function(a){for(var b=a.itemList,c=0;c<b.length;c++){var e=String(b[c][d.idtype+"Id"]);"null"===d.allItems[e]&&(d.allItems[e]=b[c])}d.currentTime=Number(a.currentTime),f>=d.batchItems.length&&d.dataComplete(),f++}})}var c,d=this,e=0,f=1;!function g(){b(e),e<d.batchItems.length-1&&(c=setTimeout(g,200),e++)}()},dataComplete:function(){var b=this,d=0;!function e(){for(var f=a.one(b.containersDOM[d]),g=b.itemId[d],h=b.itemTemplate[d],i=[],j=0;j<g.length;j++){var k=b.itemId[d][j],l=null,m=Math.ceil(7*Math.random()),n="http://img0"+m+".taobaocdn.com/bao/uploaded/i"+m;if(b.allItems[k]&&"null"!=b.allItems[k])l=b.allItems[k],l.raped||(l.picUrl=n+l.picUrl.substr(2),l.originalPrice=Number(Number(l.originalPrice)/100).toFixed(2),l.activityPrice=Number(Number(l.activityPrice)/100).toFixed(2),l.activityPriceInt=l.activityPrice.split(".")[0],l.activityPriceDecimal=l.activityPrice.split(".")[1],l.juUrl="http://ju.taobao.com/tg/home.htm?id="+l.juId,l.state=function(){return l.onlineStartTime>b.currentTime?"notbegin":l.onlineStartTime<b.currentTime&&"0"===l.isLock?"soldout":""}(),l.raped="true"),i.push(l);else if(b.trace){var o="ID:["+b.itemId[d][j]+"]商品已下架或者尚未录入!";if(!window.console)try{console.warn(o)}catch(p){}}}b.clear?f.html(c(h).render({list:i})):f.append(c(h).render({list:i})),f.addClass(b.class_done),d++,d<b.itemId.length?setTimeout(e,200):(b.imglazyload&&a.DataLazyload({diff:200}),b.callback&&b.callback({containers:b.containersDOM,items:b.itemId}))}()},init:function(){var a=this;a.getItemid(),a.getItemData()},load:function(){this.init()}},d},{requires:["dom","template","ajax","datalazyload"]});